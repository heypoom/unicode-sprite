<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Binary Editor</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" />

    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <main @drop.prevent="handleFileDrop" @dragover.prevent v-cloak>
      <div class="container">
        <div
          v-for="(bit, at) in bits"
          class="sprite"
          :class="{on: bit, off: !bit}"
          @click="toggleBit(at)"
        >
          {{Number(bit)}}
        </div>
      </div>

      <div class="export-panel">
        <button @click="exportFile">Export File</button>

        <div class="download-url" v-if="url">URL = <a :href="url">Download File</a></divc>
      </div>
    </main>

    <style scoped>
      body {
        margin: 0;
        font-family: 'JetBrains Mono', sans-serif;
      }

      main {
        color: white;
        background: black;
        min-height: 100vh;

        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;

        padding: 0px 30px;
      }

      .container {
        display: grid;
        max-width: 100%;
        grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
        grid-gap: 0;
      }

      .sprite {
        display: flex;
        align-items: center;
        justify-content: center;

        font-weight: 500;
        font-size: 9px;
        width: 40px;
        height: 40px;

        cursor: pointer;
        user-select: none;
      }

      .sprite.off {
        color: white;
        background: black;
      }

      .sprite.on {
        color: black;
        background: white;
      }

      .mode-switch {
        display: block;
        margin-top: 15px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
      }

      .export-panel {
        margin-top: 50px;
      }

      .export-panel .download-url {
        margin-top: 10px;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

    <script>
      const sizeLimits = 4000

      function chunkList(list, length) {
        const chunks = []
        let i = 0

        while (i < list.length) {
          chunks.push(list.slice(i, (i += length)))
        }

        return chunks
      }

      window.chunkList = chunkList

      const app = new Vue({
        el: 'main',
        data: {
          bits: Array.from({length: 120}, () => Number(Math.random() < 0.2)),
          url: '',
        },
        computed: {},
        methods: {
          async handleFileDrop(e) {
            const files = e.dataTransfer.files
            if (!files) return

            const [file] = files
            if (!file) return

            const buffer = await file.arrayBuffer()

            const hex = Array.from(new Uint8Array(buffer.slice(0, sizeLimits)))
            window.hex = hex

            const bits = hex
              .map((n) => n.toString(2).padStart(8, 0))
              .flatMap((str) => str.split('').map(Number))

            window.bits = bits
            this.bits = bits
          },

          /**
            @param {number} groupIndex
            @param {number} bitAt
          */
          toggleBit(bitAt) {
            Vue.set(this.bits, bitAt, Number(!this.bits[bitAt]))
          },

          exportFile() {
            URL.revokeObjectURL(this.url)

            const chunks = chunkList(this.bits, 8).map((chunk) =>
              parseInt(chunk.join(''), 2)
            )

            const blob = new Blob([new Uint8Array(chunks)])
            const url = window.URL.createObjectURL(blob)

            this.url = url
          },
        },
      })
    </script>
  </body>
</html>
